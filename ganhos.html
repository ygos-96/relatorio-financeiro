<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:ital,opsz,wght@0,14..32,100..900;1,14..32,100..900&display=swap"
        rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
        integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="src/css/reset.css">
    <link rel="stylesheet" href="src/css/buid.css">
    <title>Ganhos Mensais</title>
    <style>
        body {
            color: var(--cor-escura);
        }

        .categoria {
            padding: 5px 10px;
            border-radius: 5px;
            color: white;
            display: inline-block;
        }

        .Alimentação,
        .Salário {
            background-color: #6e5021;
        }

        .Lazer {
            background-color: #018790;
        }


        .Contas,
        .Freelancer {
            background-color: #e00b5b;
        }


        .Transporte,
        .Vale-transporte {
            background-color: #4f364a;
        }

        .Outros{
            background-color: #ffff;
            color: #000000;
            border: 1px solid #000000;
        }

        .btn-prev:hover,
        .btn-prev:active,
        .btn-prev:focus {
            outline: none;
            border: 0;
            box-shadow: none;
        }

        .line {
            background-color: var(--cor-escura);
            height: 8px;
            width: 65vw;
        }

        .btn-plus,
        .btn-plus:hover,
        .btn-plus:active,
        .btn-plus:focus {
            background-color: var(--cor-escura);
            border: 2px solid #ffff;
            bottom: 50px;
            right: 50px;
            outline: none;
            box-shadow: none;
        }

        table,
        tbody {
            max-width: 850px;
            width: 100%;
        }

        .table>:not(caption)>*>* {
            background-color: var(--cor-de-fundo) !important;
        }

        .header-table {
            border-left: 1px solid var(--cor-escura) !important;
            border-right: 1px solid var(--cor-escura) !important;
        }


        thead,
        th,
        tbody,
        td {
            border: none;
            border-style: none !important;
        }

        .value-td,
        .header-table th {
            color: var(--cor-escura) !important;
        }

        .btn-danger {
            background-color: rgb(190, 5, 5);
            border: 0;
        }

        @media (max-width:500px) {
            .line {
                width: 85vw;
            }

            th,
            td {
                font-size: 10px;
            }

            .total {
                padding: 0px !important;
            }
            .btn-plus span{
                font-size: 14px;
            }
        }
    </style>
</head>

<body class="cor-de-fundo ">
    <header class="p-4 pb-0 container d-flex justify-content-center align-items-center flex-column m-auto">
        <div class="container d-flex flex-column align-items-start justify-content-start w-100">
            <button class="btn btn-prev" onclick="goBack()"><img src="src/imagem/icones/sair.png" width="30" height="30"
                    alt="Botao de voltar"></button>
        </div>

        <div class="py-4 d-flex flex-column align-items-start justify-content-start">
            <p class="fonte-titulo fs-40 mb-0">Ganhos</p>
            <div class="line"></div>
        </div>
    </header>
    <main class="container d-flex justify-content-center align-items-center flex-column m-auto">
        <h4 class="total text-start w-75 p-4">Total: <span id="total">R$ 0,00</span></h4>

        <div class="container mt-4 d-flex justify-content-center align-items-center flex-column m-auto">
            <table class="table table-bordered mt-2">
                <thead>
                    <tr class="header-table text-center fonte-texto">
                        <th>Data</th>
                        <th>Motivo</th>
                        <th>Categoria</th>
                        <th>Valor</th>
                        <th>Ação</th>
                    </tr>
                </thead>
                <tbody id="tabela-ganhos"  class="fonte-texto text-center"></tbody>
            </table>


        </div>

        <button class="btn btn-plus position-absolute" data-bs-toggle="modal" data-bs-target="#AdicionarGasto">
            <i class="fas fa-plus text-light fs-14"></i> <span class="fonte-titulo text-light">Adicionar
                ganho</span></button>
    </main>


    <div class="modal fade" id="AdicionarGasto" tabindex="-1" aria-labelledby="AdicionarGastoLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content w-100 cor-de-fundo">
                <div class="modal-header border-0">
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="form-ganhos">
                        <label>Data e Hora:</label>
                        <input type="datetime-local" name="data" id="data" class="form-control" required>
            
                        <label>Motivo:</label>
                        <input type="text" name="motivo" id="motivo" class="form-control" required>
            
                        <label>Valor:</label>
                        <input type="text" name="valor" id="valor" class="form-control" required placeholder="0,00">
            
                        <label>Categoria:</label>
                        <select name="categoria" id="categoria" class="form-control">
                            <option value="Salário">Salário</option>
                            <option value="Vale-transporte">V.T</option>
                            <option value="Freelancer">Freelancer</option>
                            <option value="Outros">Outros</option>
                        </select>
            
                        <button type="submit" class="btn btn-primary mt-2">Adicionar</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    <script>
        function goBack() {
            if (document.referrer) {
                // Verifica se há uma página anterior
                window.history.back();
            } else {
                // Caso não haja (acesso direto à página), redireciona para um padrão
                window.location.href = "/";
            }
        }
    </script>
    <script>
        const API_URL = "https://script.google.com/macros/s/AKfycbzzGVLNPejgNSVfjkd-eJmV00E9WnLq7d6NRO-R6F1mtRREgKyw2HCAGcUzMqIcgiKi/exec";  // Substitua pela nova URL do Google Apps Script

        document.getElementById("form-ganhos").addEventListener("submit", async function (event) {
            event.preventDefault();

            let dataInput = document.getElementById("data").value;
            let motivo = document.getElementById("motivo").value;
            let valorInput = document.getElementById("valor").value;
            let categoria = document.getElementById("categoria").value;

            if (!dataInput || !motivo || !valorInput || !categoria) {
                alert("Preencha todos os campos!");
                return;
            }

            let data = formatarDataHora(dataInput);
            let valor = formatarParaNumero(valorInput);

            let ganho = { data, motivo, valor, categoria };

            try {
                let response = await fetch(API_URL, {
                    method: "POST",
                    headers: { "Content-Type": "application/x-www-form-urlencoded" },
                    body: new URLSearchParams(ganho),
                    mode: "no-cors"
                });

                salvarLocalmente(ganho);
                adicionarGanhoNaTela(ganho);
                document.getElementById("form-ganhos").reset();
            } catch (error) {
                console.error("Erro ao enviar dados:", error);
                alert("Erro ao salvar ganho.");
            }
        });

        function salvarLocalmente(ganho) {
            let ganhos = JSON.parse(localStorage.getItem("ganhos")) || [];
            ganhos.push(ganho);
            localStorage.setItem("ganhos", JSON.stringify(ganhos));
        }

        function adicionarGanhoNaTela(ganho, index = null) {
            let tabela = document.getElementById("tabela-ganhos");
            let total = parseFloat(document.getElementById("total").innerText.replace("R$ ", "").replace(".", "").replace(",", ".")) || 0;

            total += parseFloat(ganho.valor);

            let row = `<tr data-index="${index}">
                <td>${ganho.data}</td>
                <td>${ganho.motivo}</td>
                <td><span class="categoria ${ganho.categoria}">${ganho.categoria}</span></td>
                <td>R$ ${formatarParaMoeda(ganho.valor)}</td>
                <td><button class="btn btn-danger btn-sm" onclick="removerGanho(this)"><i class="fas fa-trash"></i></button></td>
            </tr>`;

            tabela.innerHTML += row;
            document.getElementById("total").innerText = `R$ ${formatarParaMoeda(total)}`;
        }

        function removerGanho(botao) {
            let linha = botao.parentNode.parentNode;
            let index = linha.getAttribute("data-index");

            let ganhos = JSON.parse(localStorage.getItem("ganhos")) || [];
            ganhos.splice(index, 1);  // Remove o item do array

            localStorage.setItem("ganhos", JSON.stringify(ganhos)); // Atualiza o LocalStorage
            linha.remove();

            // Atualiza o total
            let totalAtual = 0;
            ganhos.forEach(ganho => totalAtual += parseFloat(ganho.valor));
            document.getElementById("total").innerText = `R$ ${formatarParaMoeda(totalAtual)}`;
        }

        function formatarDataHora(dataHora) {
            let dataObj = new Date(dataHora);
            let dia = String(dataObj.getDate()).padStart(2, '0');
            let mes = String(dataObj.getMonth() + 1).padStart(2, '0');
            let ano = dataObj.getFullYear();
            let horas = String(dataObj.getHours()).padStart(2, '0');
            let minutos = String(dataObj.getMinutes()).padStart(2, '0');

            return `${dia}/${mes}/${ano} ${horas}:${minutos}`;
        }

        function formatarParaNumero(valor) {
            return valor.replace(/\./g, '').replace(',', '.');
        }

        function formatarParaMoeda(valor) {
            return parseFloat(valor).toLocaleString("pt-BR", { style: "currency", currency: "BRL" }).replace("R$", "").trim();
        }

        document.getElementById("valor").addEventListener("input", function (e) {
            let valor = e.target.value.replace(/\D/g, "");
            valor = (parseFloat(valor) / 100).toFixed(2);
            e.target.value = valor.replace(".", ",");
        });

        async function carregarGanhos() {
            let tabela = document.getElementById("tabela-ganhos");
            let total = 0;
            tabela.innerHTML = "";

            let ganhosLocais = JSON.parse(localStorage.getItem("ganhos")) || [];
            ganhosLocais.forEach((ganho, index) => {
                total += parseFloat(ganho.valor);
                adicionarGanhoNaTela(ganho, index);
            });

            document.getElementById("total").innerText = `R$ ${formatarParaMoeda(total)}`;
        }

        window.onload = carregarGanhos;
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>